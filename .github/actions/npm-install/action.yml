name: 'Windows-Focused npm Install'
description: 'Optimized npm installation for Windows-based CI/CD systems'
author: 'CI/CD Team'

inputs:
  working-directory:
    description: 'Working directory'
    required: false
    default: '.'
  node-version:
    description: 'Node.js version'
    required: false
    default: '20.x'

# Outputs removed to avoid referencing non-existent step IDs
# Use npm --version and node --version if version info is needed

runs:
  using: 'composite'
  steps:
    - name: Validate Node.js environment
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        Write-Host "Validating Node.js environment setup..."
        if (-not (Get-Command node -ErrorAction SilentlyContinue)) {
          Write-Error "Node.js not found. Ensure actions/setup-node has run."
          exit 1
        }
        if (-not (Get-Command npm -ErrorAction SilentlyContinue)) {
          Write-Error "npm not found. Node.js installation may be incomplete."
          exit 1
        }
        Write-Host ("Node.js version: {0}" -f (node --version))
        Write-Host ("npm version: {0}" -f (npm --version))

    - name: Validate environment variables
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        Write-Host "Validating critical environment variables..."
        Write-Host ("NODE_ENV: {0}" -f ($env:NODE_ENV ?? 'not set'))
        Write-Host ("NPM_CONFIG_PRODUCTION: {0}" -f ($env:NPM_CONFIG_PRODUCTION ?? 'not set'))
        if ($env:NODE_ENV -ne 'development' -or $env:NPM_CONFIG_PRODUCTION -ne 'false') {
          Write-Warning "Environment vars may prevent devDependencies installation. Recommended: NODE_ENV=development, NPM_CONFIG_PRODUCTION=false"
        }

    - name: Hardened npm install with ESM support
      shell: pwsh
      working-directory: ${{ inputs.working-directory }}
      run: |
        Write-Host "Starting Windows-focused npm installation..."
        Write-Host ("Runner: {0}" -f $env:RUNNER_OS)
        Write-Host "Current npm configuration (subset):"
        try { npm config list | Select-String -Pattern 'fetch-retries|registry|fund|audit' -SimpleMatch | ForEach-Object { $_.Line } } catch {}

        # ESM-friendly npm environment variables
        $env:NPM_CONFIG_MAXSOCKETS = '8'
        $env:NPM_CONFIG_FUND = 'false'
        $env:NPM_CONFIG_AUDIT = 'false'
        $env:NPM_CONFIG_PROGRESS = 'false'

        # Additional hardened npm configs to improve reliability on Windows CI
        npm config set fund false --location=project | Out-Null
        npm config set audit false --location=project | Out-Null
        npm config set legacy-peer-deps true --location=project | Out-Null
        npm config set fetch-retries 5 --location=project | Out-Null
        npm config set fetch-retry-maxtimeout 600000 --location=project | Out-Null
        npm config set fetch-retry-mintimeout 20000 --location=project | Out-Null

        $npmExecutable = (Get-Command npm -ErrorAction Stop).Source
        if (-not $npmExecutable) {
          throw 'npm executable not found on PATH (required for npm ci)'
        }

        function Invoke-NpmCiAttempt([int]$timeoutSec, [string]$extraArgs) {
          $psi = New-Object System.Diagnostics.ProcessStartInfo
          $psi.FileName = $npmExecutable
          $psi.WorkingDirectory = (Get-Location).Path
          # Allow postinstall scripts to run unless overridden
          $psi.Arguments = "ci $extraArgs"
          $psi.RedirectStandardOutput = $true
          $psi.RedirectStandardError = $true
          $psi.UseShellExecute = $false
          $psi.CreateNoWindow = $true
          $proc = New-Object System.Diagnostics.Process
          $proc.StartInfo = $psi
          [void]$proc.Start()
          $start = Get-Date
          $completed = $false
          while (-not $proc.HasExited) {
            Start-Sleep -Seconds 15
            $elapsed = [int]((Get-Date) - $start).TotalSeconds
            Write-Host ("[npm-install] still running... {0}s (timeout {1}s)" -f $elapsed, $timeoutSec)
            if ($elapsed -ge $timeoutSec) {
              Write-Warning "[npm-install] timeout reached; terminating npm ci"
              try { Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue } catch {}
              break
            }
          }
          if ($proc.HasExited) { $completed = $true }
          $out = $proc.StandardOutput.ReadToEnd()
          $err = $proc.StandardError.ReadToEnd()
          ($out + $err) | Out-File -FilePath npm_install.log -Append -Encoding UTF8
          if (-not $completed) { return @{ Ok=$false; TimedOut=$true; Code=-1 } }
          return @{ Ok = ($proc.ExitCode -eq 0); TimedOut=$false; Code=$proc.ExitCode }
        }

        $attempts = @(
          @{ Timeout=480; Args='' },
          @{ Timeout=720; Args='--maxsockets=5' },
          @{ Timeout=900; Args='--maxsockets=1' },
          @{ Timeout=900; Args='' }
        )

        $success = $false
        for ($i=0; $i -lt $attempts.Count; $i++) {
          $a = $attempts[$i]
          Write-Host ("Attempt {0} (timeout={1}s args='{2}')" -f ($i+1), $a.Timeout, $a.Args)
          $res = Invoke-NpmCiAttempt -timeoutSec $a.Timeout -extraArgs $a.Args
          if ($res.Ok) { $success = $true; break } else {
            if ($i -lt ($attempts.Count-1)) {
              $sleep = 15 * ($i+1)
              Write-Warning ("Attempt {0} failed (code={1}, timeout={2}). Sleeping {3}s before retry..." -f ($i+1), $res.Code, $res.TimedOut, $sleep)
              Start-Sleep -Seconds $sleep
            }
          }
        }

        if (-not $success) {
          Write-Warning "npm ci failed after retries. Falling back to 'npm install'..."
          try {
            npm cache verify | Out-Null
          } catch {}
          $LASTEXITCODE = 0
          npm install --no-audit --fund=false --prefer-offline 2>&1 | Tee-Object -FilePath npm_install.log -Append
          if ($LASTEXITCODE -ne 0) {
            Write-Error "CRITICAL FAILURE: npm install fallback failed (exit=$LASTEXITCODE)"
            if (Test-Path npm_install.log) { Get-Content npm_install.log -Tail 120 | Write-Host }
            exit 1
          } else {
            $success = $true
            Write-Host "SUCCESS: npm install fallback completed"
          }
        }

        Write-Host "SUCCESS: npm ci completed"

        # Verification
        $verificationErrors = 0
        $tools = @('eslint','tsc','vitest','playwright','tsx')
        foreach ($t in $tools) {
          $binPath = Join-Path 'node_modules/.bin' $t
          $binCmdPath = Join-Path 'node_modules/.bin' ("{0}.cmd" -f $t)
          $hasTool = Test-Path $binPath
          if (-not $hasTool) {
            $hasTool = Test-Path $binCmdPath
          }
          if ($hasTool) {
            Write-Host ("SUCCESS: {0} available in node_modules/.bin" -f $t)
          } elseif ((npm list $t | Out-Null) -ne $true) {
            Write-Warning ("{0} not detected in node_modules" -f $t)
            $verificationErrors++
          }
        }

        Write-Host "Verifying Rollup native platform package for Windows..."
        node -e "require('@rollup/rollup-win32-x64-msvc')" 2>$null
        if ($LASTEXITCODE -eq 0) { Write-Host "SUCCESS: rollup native ok" } else { Write-Warning "rollup native package not found (non-critical)" }

        $hasNodeModules = Test-Path 'node_modules'
        $hasNodeModulesBin = Test-Path 'node_modules/.bin'
        if ($hasNodeModules -and $hasNodeModulesBin) {
          $pkgCount = (Get-ChildItem 'node_modules' -Directory | Measure-Object).Count
          Write-Host ("SUCCESS: node_modules verification passed ({0} top-level packages)" -f $pkgCount)
        } else {
          Write-Error 'node_modules structure verification failed'
          $verificationErrors++
        }

        try {
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          if ($pkg.type -eq 'module') { Write-Host 'SUCCESS: ESM module system verification passed' }
        } catch {}

        if ($verificationErrors -gt 0) { Write-Warning ("Found {0} verification issues (non-blocking)" -f $verificationErrors) }

branding:
  icon: 'download'
  color: 'green'
